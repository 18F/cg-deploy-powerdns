---
name: pdns

director_uuid: 28539132-6d43-4e1b-bf40-f2ce032ee9f8

releases:
- name: pdns
  version: latest

instance_groups:
- name: pdns_private
  instances: 1
  resource_pool: pdns
  networks:
  - name: manual
    static_ips: [10.244.8.64]
  jobs:
  - release: pdns
    name: pdns
    properties:
      pdns_conf: |
        local-ipv6=
        launch=bind
        bind-config=/var/vcap/jobs/pdns/etc/named.conf
        bind-ignore-broken-records=yes
        allow-recursion=0.0.0.0/0
        allow-axfr-ips=10.244.8.0/24
        daemon=yes
        disable-axfr=no
        guardian=yes
        local-address=0.0.0.0
        local-port=53
        log-dns-details=on
        loglevel=3
        master=yes
        slave=no
        outgoing-axfr-expand-alias=yes
      named_conf: |
        zone "example.com" IN {
          type master;
          file "/var/vcap/jobs/pdns/etc/pipe.conf";
          allow-update { none; };
        };
      pipe_conf: |
        ; designates the start of this zone file in the namespace
        $ORIGIN example.com.

        ; default expiration time of all resource records without their own TTL value
        $TTL 1h

        ; @ means use $ORIGIN
        @             IN  SOA   dns1.example.com. username.example.com. ( 2017110713 30m 1h 1w 1h )
                                ; primary dns server
                                ; contact email address, replace @ with .
                                ; ( serial # for zone transfers: use YYYYMMDD + 2 digit increment
                                ; refresh every
                                ; retry
                                ; expire
                                ; min TTL )

        @             IN  NS  dns1.example.com.
        @             IN  NS  dns2.example.com.
        dns1          IN  A  10.0.1.1
        dns2          IN  A  10.0.1.2

        ; alias record for apex
        @             IN ALIAS dualstack.production-cloudfoundry-main-748290002.us-gov-west-1.elb.amazonaws.com.
        www           IN  CNAME  example.com.

        *.app.example.com IN ALIAS dualstack.production-cloudfoundry-apps-1021484088.us-gov-west-1.elb.amazonaws.com.
      dnssec:
        enabled: false

- name: pdns_public
  instances: 2
  resource_pool: pdns
  networks:
  - name: manual
    static_ips: [10.244.8.65,10.244.8.66]
  jobs:
  - release: pdns
    name: pdns
    properties:
      pdns_conf: |
        local-ipv6=
        launch=bind
        bind-config=/var/vcap/jobs/pdns/etc/named.conf
        bind-ignore-broken-records=yes
        bind-check-interval=60
        bind-dnssec-db=/var/vcap/jobs/pdns/etc/dnssec.db
        allow-recursion=0.0.0.0/0
        daemon=yes
        disable-axfr=yes
        guardian=yes
        local-address=0.0.0.0
        local-port=53
        log-dns-details=on
        loglevel=3
        master=no
        slave=yes
        slave-cycle-interval=60
      named_conf: |
        zone "example.com" IN {
          type slave;
          file "/var/vcap/jobs/pdns/etc/example.com.zone";
          masters {
            10.244.8.64;
          };
        };
      dnssec:
        enabled: true
        zones:
        - example.com

networks:
- name: manual
  type: manual
  subnets:
  - range: 10.244.8.0/24
    gateway: 10.244.8.1
    static: [10.244.8.64-10.244.8.70]

resource_pools:
- name: pdns
  network: manual
  cloud_properties: {}
  stemcell:
    name: bosh-warden-boshlite-ubuntu-trusty-go_agent
    version: latest

compilation:
  workers: 1
  network: manual
  cloud_properties: {}

update:
  canaries: 1
  max_in_flight: 3
  serial: false
  canary_watch_time: 1000-60000
  update_watch_time: 1000-60000
